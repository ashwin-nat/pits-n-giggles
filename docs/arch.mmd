%%{ init : { "theme" : "base", "themeVariables": {
    "background": "#f9fafc",
    "fontFamily": "Inter, sans-serif",
    "fontSize": "15px",
    "primaryColor": "#4ECDC4",
    "primaryTextColor": "#003049",
    "lineColor": "#003049",
    "edgeLabelBackground":"#ffffff"
}} }%%

flowchart LR

%% ---------------------------------------------------------------------------
%% External Systems
%% ---------------------------------------------------------------------------
subgraph EXTERNAL["ðŸŒ External Systems"]
direction TB
F1_SIM["ðŸŽï¸  F1 Simulator"]
EXT_TGT["ðŸŒ  External Targets"]
end

%% ---------------------------------------------------------------------------
%% Launcher and Process Manager
%% ---------------------------------------------------------------------------
subgraph PNG_LAUNCHER["ðŸš€  Pits-n-Giggles Launcher"]
direction TB
    subgraph PROC_MGR["âš™ï¸ Process Manager"]
        BACKEND_PROC_MGR["ðŸ–¥ï¸ Backend"]
        HUD_PROC_MGR["ðŸ•¶ï¸ HUD"]
        SAVE_VIEWER_PROC_MGR["ðŸ’¾ Save Viewer"]
    end
end

%% ---------------------------------------------------------------------------
%% Backend
%% ---------------------------------------------------------------------------
subgraph BACKEND["ðŸ”„ Backend Event Loop"]
direction TB
    subgraph TELEMETRY["ðŸ“¡ Telemetry Layer"]
        UDP_RECV["ðŸ“¶ UDP Receiver"]
        PARSERS["ðŸ” Parsers"]
        PACKET_FWD["ðŸ“¤ Packet Forwarder"]
    end

    subgraph INTF["ðŸ–¥ï¸ Interface Layer"]
        HTTP["ðŸŒ HTTP Server"]
        SOCKETIO["âš¡ Socket.IO"]
        IPC["ðŸ”— ZMQ IPC Server"]
    end

    subgraph STATE["ðŸ§  State Management Layer"]
        COMP_ENGINE["âš™ï¸ Computation Engine"]
        SHARED_STATE["ðŸ’¾ Shared State"]
        API_INTF["ðŸ”Œ API Interface"]
    end
end

%% ---------------------------------------------------------------------------
%% HUD Subsystem
%% ---------------------------------------------------------------------------
subgraph HUD["ðŸ•¶ï¸ HUD Subsystem"]
direction TB
HUD_IPC["ðŸ”— IPC Server"]
HUD_CLIENT["âš¡ Socket.IO Client"]
HUD_QT["ðŸ–¼ï¸ Qt Overlays"]
end

%% ---------------------------------------------------------------------------
%% Save Viewer Subsystem
%% ---------------------------------------------------------------------------
subgraph SAVE_VIEWER["ðŸ’¾ Save Viewer Subsystem"]
direction TB
SV_IPC["ðŸ”— IPC Server"]
SV_HTTP["ðŸŒ HTTP Server"]
SV_SOCKETIO["âš¡ Socket.IO Server"]
end

%% ---------------------------------------------------------------------------
%% UI Clients
%% ---------------------------------------------------------------------------
subgraph UI_CLIENTS["ðŸ’» UI Clients"]
direction TB
STREAM_OVERLAY["ðŸŽ¥ Stream Overlay"]
DRV_VIEW["ðŸ§‘ðŸŽï¸ Driver Dashboard"]
ENG_VIEW["ðŸ§‘â€ðŸ”§ Engineer Dashboard"]
end

%% ---------------------------------------------------------------------------
%% Connections
%% ---------------------------------------------------------------------------
F1_SIM -->|"Telemetry Data"| UDP_RECV
UDP_RECV --> PARSERS
UDP_RECV --> PACKET_FWD --> EXT_TGT
PARSERS --> COMP_ENGINE --> SHARED_STATE
API_INTF <-->|Read/Write| SHARED_STATE
HTTP -->|"Request"| API_INTF
SOCKETIO -->|"Emit / Listen"| API_INTF

SOCKETIO -->|"Periodic Updates"| STREAM_OVERLAY & DRV_VIEW & ENG_VIEW
HTTP -->|"Serve Pages"| UI_CLIENTS
SV_HTTP -->|"Serve Pages"| UI_CLIENTS
SV_SOCKETIO -->|"Updates"| DRV_VIEW
SOCKETIO -->|"HUD Feed"| HUD_CLIENT

BACKEND_PROC_MGR -->|"Manage / Heartbeat"| IPC
HUD_PROC_MGR -->|"Manage / Heartbeat"| HUD_IPC
SAVE_VIEWER_PROC_MGR -->|"Manage / Heartbeat"| SV_IPC

BACKEND -->|"stdout"| BACKEND_PROC_MGR
HUD -->|"stdout"| HUD_PROC_MGR
SAVE_VIEWER -->|"stdout"| SAVE_VIEWER_PROC_MGR

%% ---------------------------------------------------------------------------
%% Styles
%% ---------------------------------------------------------------------------

%% High-level sections
classDef external fill:#ff6b6b,stroke:#9b2226,color:#fff,font-weight:bold
classDef launcher fill:#ffe66d,stroke:#f77f00,stroke-width:2px,color:#000,font-weight:bold
classDef backend fill:#c0fdff,stroke:#00b4d8,stroke-width:2px,color:#03045e,font-weight:bold
classDef hud fill:#caffbf,stroke:#2a9d8f,stroke-width:2px,color:#1b4332,font-weight:bold
classDef save fill:#ffd6a5,stroke:#f48c06,stroke-width:2px,color:#78350f,font-weight:bold
classDef ui fill:#dabfff,stroke:#7209b7,stroke-width:2px,color:#240046,font-weight:bold

%% Backend sublayers
classDef telemetry fill:#ade8f4,stroke:#0077b6,stroke-width:2px,color:#03045e,font-weight:bold
classDef interface fill:#b7efc5,stroke:#2d6a4f,stroke-width:2px,color:#081c15,font-weight:bold
classDef state fill:#ffd6a5,stroke:#e85d04,stroke-width:2px,color:#78290f,font-weight:bold

class F1_SIM,EXT_TGT external
class PNG_LAUNCHER,PROC_MGR launcher
class BACKEND backend
class TELEMETRY telemetry
class INTF interface
class STATE state
class HUD hud
class SAVE_VIEWER save
class UI_CLIENTS ui
