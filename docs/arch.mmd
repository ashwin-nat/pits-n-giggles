%%{ init : { "theme" : "base", "themeVariables": {
    "background": "#f9fafc",
    "fontFamily": "Inter, sans-serif",
    "fontSize": "15px",
    "primaryColor": "#4ECDC4",
    "primaryTextColor": "#003049",
    "lineColor": "#003049",
    "edgeLabelBackground":"#ffffff"
}} }%%

flowchart TB

%% ---------------------------------------------------------------------------
%% External Systems (Top)
%% ---------------------------------------------------------------------------
subgraph EXTERNAL["   External Systems   "]
    direction LR
    F1_SIM["  F1 Simulator"]
    EXT_TGT["  External Targets"]
end

%% ---------------------------------------------------------------------------
%% Launcher and Process Manager
%% ---------------------------------------------------------------------------
subgraph PNG_LAUNCHER["   Pits n' Giggles   "]
    direction TB

    %% -------------------------------------------------------------------------
    %% Process Manager (Horizontal on top)
    %% -------------------------------------------------------------------------
    subgraph PROC_MGR["   Process Manager   "]
        direction LR
        CORE_PROG_MGR["  Core  "]
        PITWALL_PROC_MGR["  PitWall  "]
        HUD_PROC_MGR["  HUD  "]
        SAVE_VIEWER_PROC_MGR["  Save Viewer  "]
    end

    %% -------------------------------------------------------------------------
    %% PitWall Broker (Center - Hub of communication)
    %% -------------------------------------------------------------------------
    subgraph PITWALL["   PitWall Broker   "]
        direction TB
        ZMQ_PROXY["  ZMQ Proxy  "]
    end

    %% Row with Core, PitWall visually centered, and HUD
    subgraph ROW1[" "]
        direction LR

        %% -------------------------------------------------------------------------
        %% Core (Left side)
        %% -------------------------------------------------------------------------
        subgraph CORE["   Telemetry Core   "]
            direction TB
            subgraph TELEMETRY["   Telemetry Layer   "]
                direction TB
                UDP_RECV["  UDP Receiver  "]
                PARSERS["  Parsers  "]
                PACKET_FWD["  Packet Forwarder  "]
            end

            subgraph STATE["   State Management Layer   "]
                direction TB
                COMP_ENGINE["  Computation Engine  "]
                SHARED_STATE["  Shared State  "]
                API_INTF["  API Interface  "]
            end

            subgraph INTF["   Interface Layer   "]
                direction TB
                HTTP["  HTTP Server  "]
                SOCKETIO["  Socket.IO  "]
                IPC["  ZMQ IPC Server  "]
                ZMQ_PUB["  ZMQ Publisher  "]
            end
        end

        %% -------------------------------------------------------------------------
        %% HUD Subsystem (Right side)
        %% -------------------------------------------------------------------------
        subgraph HUD["   HUD Subsystem   "]
            direction TB
            subgraph HUD_INPUT["   Input Layer   "]
                direction LR
                HUD_IPC["  IPC Server  "]
                HUD_SUB["  ZMQ Subscriber  "]
            end
            HUD_QT["  Qt Overlays  "]
        end
    end

    %% -------------------------------------------------------------------------
    %% Save Viewer Subsystem (Bottom)
    %% -------------------------------------------------------------------------
    subgraph SAVE_VIEWER["   Save Viewer Subsystem   "]
        direction LR
        SV_IPC["  IPC Server  "]
        SV_STATE["  State  "]
        SV_HTTP["  HTTP Server  "]
        SV_SOCKETIO["  Socket.IO Server  "]
    end
end

%% ---------------------------------------------------------------------------
%% UI Clients (Bottom)
%% ---------------------------------------------------------------------------
subgraph UI_CLIENTS["   UI Clients   "]
    direction LR
    STREAM_OVERLAY["  Stream Overlay  "]
    DRV_VIEW["  Driver Dashboard  "]
    ENG_VIEW["  Engineer Dashboard  "]
end

%% ---------------------------------------------------------------------------
%% Connections - Telemetry Flow
%% ---------------------------------------------------------------------------
F1_SIM -->|"Telemetry Data"| UDP_RECV
UDP_RECV --> PARSERS
UDP_RECV --> PACKET_FWD --> EXT_TGT
PARSERS --> COMP_ENGINE
COMP_ENGINE --> SHARED_STATE

%% ---------------------------------------------------------------------------
%% Connections - Core Internal
%% ---------------------------------------------------------------------------
API_INTF <-->|"Read/Write"| SHARED_STATE
HTTP -->|"Request"| API_INTF
SOCKETIO <-->|"Read / Fetch"| API_INTF

%% ---------------------------------------------------------------------------
%% Connections - ZMQ Pub/Sub Flow (Core -> PitWall -> HUD)
%% ---------------------------------------------------------------------------
ZMQ_PUB -->|"Publish"| ZMQ_PROXY
ZMQ_PROXY -->|"Subscribe"| HUD_SUB
HUD_SUB -->|"Data Feed"| HUD_QT

%% ---------------------------------------------------------------------------
%% Connections - UI Clients
%% ---------------------------------------------------------------------------
SOCKETIO -->|"Periodic Updates"| STREAM_OVERLAY
SOCKETIO -->|"Periodic Updates"| DRV_VIEW
SOCKETIO -->|"Periodic Updates"| ENG_VIEW
HTTP -->|"Serve Pages"| UI_CLIENTS

%% ---------------------------------------------------------------------------
%% Connections - Save Viewer
%% ---------------------------------------------------------------------------
SV_HTTP -->|"Serve Pages"| UI_CLIENTS
SV_SOCKETIO -->|"Updates"| DRV_VIEW
SV_IPC -->|"Save file path"| SV_STATE
SV_SOCKETIO -->|"Read"| SV_STATE
SV_STATE -->|"Notify"| SV_SOCKETIO

%% ---------------------------------------------------------------------------
%% Connections - Process Management (from top horizontal bar to all subsystems)
%% ---------------------------------------------------------------------------
CORE -->|"stdout"| CORE_PROG_MGR
PITWALL -->|"stdout"| PITWALL_PROC_MGR
HUD -->|"stdout"| HUD_PROC_MGR
SAVE_VIEWER -->|"stdout"| SAVE_VIEWER_PROC_MGR

CORE_PROG_MGR -->|"Manage / Heartbeat"| IPC
PITWALL_PROC_MGR -->|"Manage / Heartbeat"| ZMQ_PROXY
HUD_PROC_MGR -->|"Manage / Heartbeat"| HUD_IPC
SAVE_VIEWER_PROC_MGR -->|"Manage / Heartbeat"| SV_IPC

%% ---------------------------------------------------------------------------
%% Connections - HUD Control
%% ---------------------------------------------------------------------------
HUD_IPC -->|"Commands"| HUD_QT
HUD_QT -->|"Responses"| HUD_IPC

%% ---------------------------------------------------------------------------
%% Styles
%% ---------------------------------------------------------------------------

%% High-level sections
classDef external fill:#ff6b6b,stroke:#9b2226,color:#fff,font-weight:bold
classDef launcher fill:#ffe66d,stroke:#f77f00,stroke-width:2px,color:#000,font-weight:bold
classDef core fill:#c0fdff,stroke:#00b4d8,stroke-width:2px,color:#03045e,font-weight:bold
classDef pitwall fill:#ffc6ff,stroke:#9d4edd,stroke-width:2px,color:#3c096c,font-weight:bold
classDef hud fill:#caffbf,stroke:#2a9d8f,stroke-width:2px,color:#1b4332,font-weight:bold
classDef save fill:#ffd6a5,stroke:#f48c06,stroke-width:2px,color:#78350f,font-weight:bold
classDef ui fill:#dabfff,stroke:#7209b7,stroke-width:2px,color:#240046,font-weight:bold
classDef row fill:none,stroke:none
classDef input fill:#a7f3d0,stroke:#059669,stroke-width:2px,color:#064e3b,font-weight:bold

%% Core sublayers
classDef telemetry fill:#ade8f4,stroke:#0077b6,stroke-width:2px,color:#03045e,font-weight:bold
classDef interface fill:#b7efc5,stroke:#2d6a4f,stroke-width:2px,color:#081c15,font-weight:bold
classDef state fill:#ffd6a5,stroke:#e85d04,stroke-width:2px,color:#78290f,font-weight:bold

class F1_SIM,EXT_TGT external
class PNG_LAUNCHER,PROC_MGR launcher
class CORE core
class TELEMETRY telemetry
class INTF interface
class STATE state
class PITWALL pitwall
class HUD hud
class HUD_INPUT input
class SAVE_VIEWER save
class UI_CLIENTS ui
class ROW1 row
