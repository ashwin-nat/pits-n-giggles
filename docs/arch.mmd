%%{ init : { "theme" : "base", "themeVariables": {
  "background": "#0b1020",
  "primaryColor": "#1f6feb",
  "primaryTextColor": "#e6edf3",
  "secondaryColor": "#8250df",
  "tertiaryColor": "#3fb950",
  "lineColor": "#8b949e",
  "edgeLabelBackground": "#0b1020",
  "fontFamily": "Inter, JetBrains Mono, sans-serif",
  "fontSize": "14px",
  "clusterBkg": "#0d1117",
  "clusterBorder": "#30363d"
}} }%%

%% ---------------------------------------------------------------------------
%% pits_n_giggles â€” Clean Telemetry & UI Architecture
%% Visual style: dark, neon-accented, left-to-right narrative flow
%% ---------------------------------------------------------------------------
flowchart LR

%% ===========================================================================
%% External Systems
%% ===========================================================================
subgraph EXTERNAL[" External Systems"]
  direction TB
  F1_SIM[" F1 Simulator"]
  EXT_TGT[" External Targets"]
end

%% ===========================================================================
%% Core Telemetry Stack
%% ===========================================================================
subgraph CORE[" Telemetry Core"]
  direction TB

  subgraph TELEMETRY[" Telemetry Ingest"]
    direction TB
    UDP_RECV["UDP Receiver"]
    PARSERS["Packet Parsers"]
    PACKET_FWD["Packet Forwarder"]
  end

  subgraph STATE[" State & Computation"]
    direction TB
    COMP_ENGINE["Computation Engine"]
    SHARED_STATE["Shared State"]
    API_INTF["State Interface"]
  end

  subgraph INTF[" Core Interfaces"]
    direction TB
    HTTP["HTTP Server"]
    SOCKETIO["Socket.IO"]
    ZMQ_PUB["ZMQ Publisher"]
    IPC["IPC Server"]
  end
end

%% ===========================================================================
%% Message Distribution
%% ===========================================================================
subgraph PITWALL[" PitWall Broker"]
  direction TB
  ZMQ_PROXY["ZMQ Proxy"]
end

%% ===========================================================================
%% HUD Subsystem
%% ===========================================================================
subgraph HUD[" HUD Subsystem"]
  direction TB
  HUD_SUB["ZMQ Subscriber"]
  HUD_SOCKETIO["Socket.IO"]
  HUD_IPC["IPC Server"]
  HUD_QT["Qt Overlays"]
end

%% ===========================================================================
%% Save Viewer
%% ===========================================================================
subgraph SAVE_VIEWER[" Save Viewer"]
  direction TB
  SV_IPC["IPC Server"]
  SV_STATE["State"]
  SV_HTTP["HTTP Server"]
  SV_SOCKETIO["Socket.IO"]
end

%% ===========================================================================
%% Web Clients
%% ===========================================================================
subgraph UI[" Web Clients"]
  direction TB
  STREAM_OVERLAY[" Stream Overlay"]
  DRV_VIEW[" Driver Dashboard"]
  ENG_VIEW[" Engineer Dashboard"]
end

%% ===========================================================================
%% Primary Telemetry Flow (Hot Path)
%% ===========================================================================
F1_SIM ==> UDP_RECV ==> PARSERS ==> COMP_ENGINE ==> SHARED_STATE
UDP_RECV -.-> PACKET_FWD -.-> EXT_TGT

%% ===========================================================================
%% Core State Fan-out
%% ===========================================================================
SHARED_STATE ==> API_INTF
API_INTF ==> HTTP
API_INTF ==> SOCKETIO
API_INTF ==> ZMQ_PUB

%% ===========================================================================
%% ZMQ Low-Latency Distribution
%% ===========================================================================
ZMQ_PUB ==> ZMQ_PROXY ==> HUD_SUB ==> HUD_QT

%% ===========================================================================
%% Socket.IO UI Distribution
%% ===========================================================================
SOCKETIO ==> HUD_SOCKETIO ==> HUD_QT
SOCKETIO ==> STREAM_OVERLAY
SOCKETIO ==> DRV_VIEW
SOCKETIO ==> ENG_VIEW

%% ===========================================================================
%% Control & Playback Paths
%% ===========================================================================
IPC -.-> SV_IPC -.-> SV_STATE -.-> SV_SOCKETIO
SV_HTTP ==> DRV_VIEW
SV_SOCKETIO ==> DRV_VIEW
HUD_IPC ==> HUD_QT

%% ===========================================================================
%% Styling
%% ===========================================================================
classDef external fill:#ff7b72,stroke:#ff7b72,color:#0b1020,font-weight:bold
classDef core fill:#1f6feb,stroke:#58a6ff,color:#e6edf3,font-weight:bold
classDef pitwall fill:#8250df,stroke:#a371f7,color:#e6edf3,font-weight:bold
classDef hud fill:#3fb950,stroke:#56d364,color:#0b1020,font-weight:bold
classDef save fill:#d29922,stroke:#f2cc60,color:#0b1020,font-weight:bold
classDef ui fill:#db6d28,stroke:#ffa657,color:#0b1020,font-weight:bold

class F1_SIM,EXT_TGT external
class CORE,TELEMETRY,STATE,INTF core
class PITWALL pitwall
class HUD hud
class SAVE_VIEWER save
class UI ui
