%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#fff','primaryTextColor':'#000','primaryBorderColor':'#999','lineColor':'#666','secondaryColor':'#f9f9f9','tertiaryColor':'#fff','background':'#ffffff','mainBkg':'#ffffff','clusterBkg':'#f8f9fa','clusterBorder':'#adb5bd','edgeLabelBackground':'#ffffff'}}}%%

graph TD

subgraph EXT["ðŸ”Œ External Threads"]
    direction TB
    IPC["IPC Server Thread"]
    SUB["IPC Subscriber Client Thread"]
end

subgraph OM["L1 - OverlaysManager"]
    direction TB
    OM_Cmd["handle_control_cmd()"]
    OM_Data["handle_data_update()"]
    OM_Req["perform_request()"]
end

subgraph WMALL["L2 - WindowManager"]
    direction TB
    subgraph WM["WindowManager API"]
        direction TB
        API_BC["broadcast_data()"]
        API_UC["unicast_data()"]
        API_REQ["request()"]
    end

    subgraph WMSIG["WindowManager Signals"]
        direction TB
        Sig_CMD["cmd_signal"]
        Sig_REQ["request_signal"]
        Sig_RESP["response_signal"]
        RespStore["_response_data"]
    end
end

subgraph BASE["L3 - Overlay Base Layer"]
    direction TB
    BaseOverlay["BaseOverlay<br/>Command Registry<br/>Request Registry"]
end

subgraph OVERLAYS["L4 - Implementation Layer"]
    direction TB
    TimingTowerOverlay["Timing Tower Overlay"]
    LapTimeOverlay["Lap Time Overlay"]

    subgraph MFD["MFD System"]
        direction TB
        MFDCommandRouter["MFD Overlay"]
        subgraph MFDCTRL["Control Path"]
            MFDHandlers["Control Handler"]
            SwitchPage["_switch_page()"]
        end

        subgraph MFDDATA["Data Path"]
            ForwardData["Forward to Page"]
            ActivePage["Active Page"]
        end
    end
end

subgraph PAGES["L5 - MFD Page Events"]
    direction TB
    PageReg["Event Registry"]
    UpdateUI["Update UI"]
end

%% ========= Top-Down Flows =========
IPC -->|control cmd| OM_Cmd
SUB -->|data update| OM_Data
IPC -->|request| OM_Req

OM_Cmd --> API_UC
OM_Data --> API_BC
OM_Req --> API_REQ

API_BC --> Sig_CMD
API_UC --> Sig_CMD
API_REQ --> Sig_REQ

Sig_CMD --> BaseOverlay
Sig_REQ --> BaseOverlay

BaseOverlay --> TimingTowerOverlay
BaseOverlay --> LapTimeOverlay
BaseOverlay --> MFDCommandRouter

%% Response path (upward dotted)
BaseOverlay -.->|emit response| Sig_RESP
Sig_RESP --> RespStore
RespStore --> OM_Req

%% MFD-specific flows
MFDCommandRouter -->|control| MFDHandlers
MFDCommandRouter -->|data| ForwardData

MFDHandlers --> SwitchPage
ForwardData --> ActivePage

ActivePage --> PageReg
PageReg --> UpdateUI

%% ========= Light Theme Styles =========
classDef thread fill:#fee2e2,stroke:#dc2626,color:#991b1b,stroke-width:2.5px,rx:8
classDef manager fill:#dbeafe,stroke:#2563eb,color:#1e40af,stroke-width:2.5px,rx:8
classDef signal fill:#fef3c7,stroke:#f59e0b,color:#92400e,stroke-width:2.5px,rx:8
classDef overlay fill:#d1fae5,stroke:#10b981,color:#065f46,stroke-width:2.5px,rx:8
classDef special fill:#e0e7ff,stroke:#6366f1,color:#3730a3,stroke-width:2.5px,rx:8
classDef page fill:#fae8ff,stroke:#a855f7,color:#6b21a8,stroke-width:2.5px,rx:8

class IPC,SUB thread
class OM_Cmd,OM_Data,OM_Req,API_BC,API_UC,API_REQ,RespStore manager
class Sig_CMD,Sig_REQ,Sig_RESP signal
class BaseOverlay,TimingTowerOverlay,LapTimeOverlay overlay
class MFDCommandRouter,MFDHandlers,SwitchPage,ForwardData special
class ActivePage,PageReg,UpdateUI page
