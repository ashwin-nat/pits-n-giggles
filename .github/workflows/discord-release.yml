name: Test Discord Release Post

on:
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release Name'
        required: true
        default: 'vTest'
      release_url:
        description: 'Release URL'
        required: true
        default: 'https://github.com/user/repo/releases/tag/vTest'
      release_body:
        description: 'Release Notes (first 4000 characters will be used)'
        required: false
        default: |
          - Feature: Something cool 🚀
          - Fix: Something annoying 🐞
          - Note: This is a test of the Discord webhook integration.

jobs:
  post-to-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Set env variables from input
        run: |
          echo "RELEASE_NAME=${{ github.event.inputs.release_name }}" >> $GITHUB_ENV
          echo "RELEASE_URL=${{ github.event.inputs.release_url }}" >> $GITHUB_ENV

          # Properly export multiline body as env var
          {
            echo "RELEASE_BODY<<EOF"
            echo "${{ github.event.inputs.release_body }}" | head -c 4000 | sed 's/`/\\`/g'
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Post to Discord
        run: |
          curl -H "Content-Type: application/json" -X POST \
            -d "{
              \"content\": \"📦 **New Release: $RELEASE_NAME**\n$RELEASE_URL\n\n$RELEASE_BODY\"
            }" \
            ${{ secrets.DISCORD_WEBHOOK }}
