name: Notify Discord of New Stable Release

on:
  release:
    types: [published]

  workflow_dispatch:
    inputs:
      title:
        description: 'Release title (shown in Discord)'
        required: true
      tag:
        description: 'Release tag (e.g. v3.2.0)'
        required: true

jobs:
  discord:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────
      # Real GitHub release (stable only)
      # ─────────────────────────────────────────────
      - name: Post Discord notification (release)
        if: ${{ github.event_name == 'release' && github.event.release.prerelease == false && github.event.release.draft == false }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          RELEASE_TITLE: ${{ github.event.release.name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"New Release: **${RELEASE_TITLE}**\n${RELEASE_URL}\"
            }" \
            "$DISCORD_WEBHOOK"

      # ─────────────────────────────────────────────
      # Manual trigger (for testing / re-posting)
      # ─────────────────────────────────────────────
      - name: Post Discord notification (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          RELEASE_TITLE: ${{ github.event.inputs.title }}
          RELEASE_TAG: ${{ github.event.inputs.tag }}
          RELEASE_URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.tag }}
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"New Release: **${RELEASE_TITLE}**\n${RELEASE_URL}\"
            }" \
            "$DISCORD_WEBHOOK"
