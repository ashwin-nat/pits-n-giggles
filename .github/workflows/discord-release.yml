name: Post Release to Discord

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4

      - name: 📦 Install GitHub CLI + jq
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: 🧠 Get latest release info
        id: release
        run: |
          gh release view --json name,tagName,url,body > release.json
          echo "RELEASE_NAME=$(jq -r '.name // .tagName' release.json)" >> $GITHUB_ENV
          echo "RELEASE_URL=$(jq -r '.url' release.json)" >> $GITHUB_ENV

          # Escape Discord-unfriendly chars
          RELEASE_BODY=$(jq -r '.body' release.json | head -c 4000 | sed 's/`/\\`/g')

          # Multiline-safe export
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 🚀 Post to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          RELEASE_NAME: ${{ env.RELEASE_NAME }}
          RELEASE_URL: ${{ env.RELEASE_URL }}
          RELEASE_BODY: ${{ env.RELEASE_BODY }}
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"📦 New Release: $RELEASE_NAME\",
                \"url\": \"$RELEASE_URL\",
                \"description\": \"$RELEASE_BODY\",
                \"color\": 5814783
              }]
            }" \
            "$DISCORD_WEBHOOK"
