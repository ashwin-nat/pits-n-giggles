name: Post to Discord on Release

on:
  release:
    types: [published]

jobs:
  discord-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install jq

      - name: Fetch release info
        run: |
          gh release view --json name,tagName,url,body > release.json
          echo "RELEASE_NAME=$(jq -r '.name // .tagName' release.json)" >> $GITHUB_ENV
          echo "RELEASE_URL=$(jq -r '.url' release.json)" >> $GITHUB_ENV

          # Escape backticks for Discord formatting and limit body to 4000 chars
          RELEASE_BODY=$(jq -r '.body' release.json | head -c 4000 | sed 's/`/\\`/g')

          # Export multiline safely
          {
            echo "RELEASE_BODY<<EOF"
            echo "$RELEASE_BODY"
            echo "EOF"
          } >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post to Discord
        run: |
          curl -H "Content-Type: application/json" -X POST \
            -d "{
              \"content\": \"ðŸ“¦ **New Release: $RELEASE_NAME**\n$RELEASE_URL\n\n$RELEASE_BODY\"
            }" \
            ${{ secrets.DISCORD_WEBHOOK }}
