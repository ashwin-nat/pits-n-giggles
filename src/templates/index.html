<!--
MIT License

Copyright (c) [2024] [Ashwin Natarajan]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Pits n' Giggles</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Bangers&display=swap"
        rel="stylesheet">
    <style>
        /* Your existing styles */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            /* Black background */
            color: #fdd835;
            /* Gold text */
            position: relative;
        }

        .top-section {
            display: flex;
            justify-content: space-around;
            align-items: stretch;
            gap: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow: hidden;
            margin-bottom: 1px;
            /* Adjust the margin-bottom as needed */
        }

        .weather-box,
        .race-info-box,
        .time-box {
            flex: 1;
            padding: 1px;
            background-color: #2e2e2e;
            /* Dark grey for Gotham feel */
            border: 2px solid #fdd835;
            /* Highlighted border in gold */
            border-radius: 10px;
            color: #fdd835;
            /* Text in gold */
            font-size: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            line-height: 1;
        }

        .race-info-box {
            line-height: 0.5;
        }

        table {
            width: 100%;
            table-layout: fixed;
            margin: 20px 0;
            background-color: #000;
            /* Black background */
            color: #fdd835;
            /* Gold text */
            border-spacing: 0;
            font-size: 24px;
        }

        th,
        td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #2e2e2e;
            /* Dark grey row separation */
        }

        th {
            background-color: #2e2e2e;
            /* Dark grey header background */
            color: #fdd835;
            /* Gold header text */
            font-weight: 700;
        }

        tbody tr:nth-child(even) {
            background-color: #1a1a1a;
            /* Darker shade for even rows */
        }

        .player-row td {
            font-weight: bold;
            border-color: #fdd835;
            /* Gold border */
        }

        .player-row td:first-child {
            border-left: 2px solid #fdd835;
            /* Left border on the first cell */
        }

        .player-row td:last-child {
            border-right: 2px solid #fdd835;
            /* Right border on the last cell */
        }

        .player-row td {
            border-top: 2px solid #fdd835 !important;
            /* Top border on all cells */
            border-bottom: 2px solid #fdd835 !important;
            /* Bottom border on all cells */
        }

        .fastest-lap {
            background-color: #E829F1 !important;
            /* Purple for fastest lap */
            color: #fff !important;
            /* White text for contrast */
        }

        .dnf {
            background-color: #771010 !important;
            /* Red for DNF */
            color: #fff !important;
            /* White text for contrast */
        }

        .dsq {
            background-color: #000000 !important;
            /* Black for DSQ */
            color: #fff !important;
            /* White text for contrast */
        }

        .drs-active {
            color: #28a745 !important;
            /* Green font color for DRS active, no background change */
        }

        /* Remove link styling */
        .motivationLink {
            color: #fdd835;
            /* Text in gold */
            cursor: pointer;
            text-decoration: underline;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Add background opacity */
            background-color: rgba(31, 30, 30, 0.9);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #181717;
            padding: 20px;
            border-radius: 10px;
            text-align: center;

            /* Set width to 80% of the viewport width */
            width: 80%;

            /* Set max height to 80% of the viewport height */
            max-height: 80vh;

            /* Set overflow-y to auto to enable scrolling if the content exceeds the max height */
            overflow-y: auto;

            /* Change font color to standard gold */
            color: #fdd835;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .accordion {
            overflow: hidden;
            margin-bottom: 10px;
        }

        .accordion-title {
            background-color: #2e2e2e;
            /* Dark grey header background */
            color: #fdd835;
            /* Gold header text */
            cursor: pointer;
            padding: 14px;
            width: 100%;
            text-align: center;
            border: none;
            outline: none;
            transition: background-color 0.3s;
            font-size: larger;
            font-family: 'Roboto', sans-serif;
        }

        .accordion-content {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            width: 100%;
        }

        .graph-canvas {
            width: 1400px !important;
            /* height: 900px !important; */
            align-items: center;
            margin: auto;
        }
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <!-- Include Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="top-section">
        <div class="weather-box">
            <!-- Weather table -->
            <table id="weatherTable">
                <thead>
                    <tr>
                        <th>Time Offset</th>
                        <th>Rain Probability</th>
                        <th>Weather</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="race-info-box">
            <h2 id="tableTitle">F1 Telemetry Live</h2>
            <p id="trackTemperature">Track Temperature: </p>
            <p id="lapInformation">Lap: </p>
            <p id="safetyCarStatus" style="display: none;">Safety Car Status: </p>
            <p><a href="#" id="getRaceInfo" class="motivationLink">Get Race Information</a></p>
            <p><a href="#" id="saveTelemetryLink" class="motivationLink">Save telemetry packet capture</a></p>
        </div>
        <div class="time-box">
            <p id="localTime" class="motivationLink">Local Time: </p>
            <p id="fastestLapOverall">Fastest Lap Overall: </p>
            <p id="pitSpeedLimit">Pit Lane Speed Limit: </p>
            <a href="javascript:void(0);" id="motivationLink" class="motivationLink">Click here for motivation</a>
        </div>
    </div>

    <!-- YouTube iframe for audio, set to play when the link is clicked -->
    <iframe id="youtubeAudio" class="youtube-audio" width="0" height="0"
        src="https://www.youtube.com/embed/2L7Qm2hBJ6o?start=38&enablejsapi=1" frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen></iframe>

    <table id="raceTable">
        <thead>
            <tr>
                <th>Position</th>
                <th>Driver</th>
                <th id="deltaLink" class="motivationLink">Delta</th>
                <th>ERS</th>
                <th>Warnings</th>
                <th id="bestLapLink" class="motivationLink">Best</th>
                <th id="lastLapLink" class="motivationLink">Last</th>
                <th>Tyre Info</th>
                <th>Wear Prediction</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="driverInfoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('driverInfoModal')">&times;</span>
            <h2 id="modalTitle">Driver Information</h2>
            <div id="modalContent" style="height: 90vh; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        var player; // Define YT player
        let is24HourFormat = true; // Initial format
        let relativeDelta = false; // Initial format
        let lastLapAbsoluteFormat = false; // Initial format
        let bestLapAbsoluteFormat = true; // Initial format
        // Check if delta column needs to be displayed
        const shouldHideDeltaColumn = {{ live_data_mode | tojson | safe }};
        const shouldHidePredictionColumn = !{{ live_data_mode | tojson | safe }};

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtubeAudio', {
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            var motivationLink = document.getElementById("motivationLink");
            motivationLink.addEventListener("click", playAudio);

            // Simulate a click to auto play the video when the page loads
            motivationLink.click();
        }

        function playAudio() {
            // Play the audio
            player.playVideo();

            // Set a timeout to stop the audio after 5000 milliseconds (5 seconds)
            setTimeout(stopAudio, 5000);
        }

        function stopAudio() {
            // Pause the audio
            player.pauseVideo();
        }

        function formatFloatWithTwoDecimals(floatNumber) {
            if (typeof floatNumber !== 'number' || isNaN(floatNumber)) {
                console.error('Invalid input. Please provide a valid number.');
                return null;
            }

            // Use toFixed to round to two decimal places and convert to string
            return floatNumber.toFixed(2);
        }

        function formatFloatWithTwoDecimalsSigned(floatNumber) {
            if (typeof floatNumber !== 'number' || isNaN(floatNumber)) {
                console.error('Invalid input. Please provide a valid number.');
                return null;
            }

            // Use toFixed to round to two decimal places and convert to string
            const floatStr = floatNumber.toFixed(2);
            if (floatNumber >= 0.0) {
                return '+' + floatStr;
            } else {
                return floatStr;
            }
        }

        function fetchDataAndDisplay() {
            const endpoint = "{{ 'player-telemetry-info' if player_only_telemetry else 'telemetry-info' }}";
            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    if ('table-entries' in data) {
                        updateRaceTable(data["table-entries"]);
                    }
                    updateGlobalInfo(data["circuit"], data["event-type"], data["track-temperature"], data["current-lap"],
                        data["total-laps"], data["safety-car-status"], data["fastest-lap-overall"],
                        data["pit-speed-limit"], {{ packet_capture_enabled | tojson }});
                    updateWeatherTable(data["weather-forecast-samples"]);
                })
                .catch (error => {
            console.error('Error fetching data:', error);
        });
        }

        function updateWeatherTable(weatherData) {
            const weatherTableBody = document.querySelector('#weatherTable tbody');
            weatherTableBody.innerHTML = '';

            let iterationCount = 0; // Counter to track the number of iterations
            const maxWeatherSamples = 5;
            weatherData.forEach(data => {
                if (iterationCount < maxWeatherSamples) {
                    const row = weatherTableBody.insertRow();
                    row.insertCell().textContent = data["time-offset"];
                    row.insertCell().textContent = data["rain-probability"];
                    row.insertCell().textContent = data["weather"];

                    iterationCount++; // Increment the counter after each iteration
                } else {
                    // Break out of the loop if the maximum iterations (5) is reached
                    return;
                }
            });
        }

        function updateRaceTable(entries) {

            function truncateName(name) {

                const maxLength = 25;
                if (name.length > maxLength) {
                    return name.substring(0, maxLength - 3) + '...';
                } else {
                    return name;
                }
            }

            const tableBody = document.querySelector('#raceTable tbody');
            tableBody.innerHTML = '';

            entries.forEach(entry => {
                const row = tableBody.insertRow();

                // Position column
                const positionCell = row.insertCell();
                positionCell.textContent = entry["position"];

                // Create a clickable link for the driver's name
                const nameCell = row.insertCell();
                const nameLink = document.createElement('a');
                nameLink.innerHTML =    `${truncateName(entry["name"])}` +
                                        `<br>` +
                                        `${truncateName(entry["team"])}`;
                nameLink.href = '#'; // Set a placeholder href value

                // Get the computed style of the row and apply it to the hyperlink
                const rowStyles = window.getComputedStyle(row);
                nameLink.style.color = rowStyles.getPropertyValue('color');
                nameLink.style.fontFamily = rowStyles.getPropertyValue('font-family');

                nameLink.style.textDecoration = 'underline'; // Add standard link underline
                nameLink.onclick = function () {
                    handleDriverInfoClick(entry["index"]);
                };
                nameCell.appendChild(nameLink);

                if (!shouldHideDeltaColumn) {
                    if (relativeDelta) {
                        row.insertCell().textContent = entry["delta"];
                    } else {
                        row.insertCell().textContent = entry["delta-to-leader"];
                    }
                }
                row.insertCell().textContent = entry["ers"];

                const warningsPensCell = row.insertCell();
                const dtPlusSg = entry["num-dt"] + "DT + " +
                    entry["num-sg"] + "SG";

                warningsPensCell.innerHTML =
                    `Pens: ${entry["time-penalties"]} sec<br>` +
                    `Warns: ${entry["corner-cutting-warnings"]}<br>` +
                    `${dtPlusSg}`;

                if (bestLapAbsoluteFormat || entry["is-spectating"]) {
                    row.insertCell().textContent = entry["best"];
                } else {
                    row.insertCell().textContent = entry["best-lap-delta"];
                }

                if (lastLapAbsoluteFormat || entry["is-spectating"]) {
                    row.insertCell().textContent = entry["last"];
                } else {
                    row.insertCell().textContent = entry["last-lap-delta"];
                }

                const tyreInfoCell = row.insertCell();
                tyreInfoCell.innerHTML = `${entry["average-tyre-wear"]}<br>` +
                    `${entry["tyre-age"]} lap(s) ` + `(${entry["num-pitstops"]} pit)<br>` +
                    `${entry["tyre-compound"]}`;

                if (!shouldHidePredictionColumn) {
                    let predictionHTML = ""; // Declare predictionHTML outside the loop
                    predictionData = entry["tyre-wear-prediction"];
                    if (predictionData.length === 0) {
                        predictionHTML = "N/A";
                    } else {
                        predictionData.forEach((prediction, index) => {
                            const flWear = prediction["front-left-wear"];
                            const frWear = prediction["front-right-wear"];
                            const rlWear = prediction["rear-left-wear"];
                            const rrWear = prediction["rear-right-wear"];
                            const lapNum = prediction["lap-number"];
                            const avgWear = formatFloatWithTwoDecimals((flWear + frWear + rlWear + rrWear) / 4); // Corrected variable name
                            predictionHTML += "Lap " + lapNum + ": " + avgWear + "%<br>"; // Concatenate prediction strings
                        });
                    }
                    row.insertCell().innerHTML = predictionHTML; // Set innerHTML outside the loop
                }

                row.className = '';
                if (entry["is-fastest"]) {
                    row.classList.add('fastest-lap');
                }

                switch (entry["dnf-status"]) {
                    case "DNF":
                        row.classList.add('dnf');
                        break;
                    case "DSQ":
                        row.classList.add('dsq');
                        break;
                    // Add more cases if needed
                    default:
                    // Default case if none of the cases match
                }

                if (entry["is-player"]) {
                    row.classList.add('player-row'); // Apply the player-row class to the row
                }

                // Fix for DRS active styling
                if (entry["drs"] === true) {
                    Array.from(row.cells).forEach(cell => cell.classList.add('drs-active'));
                    row.classList.add('drs-active'); // Add class to the row
                    nameLink.classList.add('drs-active')
                }
            });
        }

        function handleDriverInfoClick(index) {
            fetch(`/driver-info?index=${index}`)
                .then(response => response.json())
                .then(data => {
                    openDriverInfoModal(data);
                })
                .catch(error => {
                    console.error('Error fetching driver info:', error);
                });
        }

        function createAccordion(title, content) {
            const accordion = document.createElement('div');
            accordion.className = 'accordion';

            const accordionTitle = document.createElement('button');
            accordionTitle.className = 'accordion-title';
            accordionTitle.innerText = title;

            const accordionContent = document.createElement('div');
            accordionContent.className = 'accordion-content';
            accordionContent.appendChild(content);

            accordion.appendChild(accordionTitle);
            accordion.appendChild(accordionContent);

            // Add event listener for the accordion
            accordionTitle.addEventListener('click', function () {
                accordion.classList.toggle('active');
                if (accordion.classList.contains('active')) {
                    // Set max-height to the scrollHeight only if the accordion is being opened
                    accordionContent.style.maxHeight = accordionContent.scrollHeight + 'px';
                } else {
                    // Set max-height to 0 when the accordion is being closed
                    accordionContent.style.maxHeight = null;
                }
            });

            return accordion;
        }

        function formatLapTime(milliseconds) {
            var minutes = Math.floor(milliseconds / 60000);
            var seconds = Math.floor((milliseconds % 60000) / 1000);
            var millisecondsPart = (milliseconds % 1000).toFixed(3).padStart(3, '0');
            return minutes.toString().padStart(2, '0') + ":" + seconds.toString().padStart(2, '0') + "." + millisecondsPart;
        }

        function getDriverInfoFromIndex(data, index) {
            const classificationData = data["classification-data"];

            for (let i = 0; i < classificationData.length; i++) {
                const driverData = classificationData[i];

                if (driverData["index"] == index) {
                    return {
                        'driver-name': driverData["participant-data"]["name"],
                        'team-name': driverData["participant-data"]["team-id"]
                    };
                }
            }

            // If the index is not found, return null values
            return {
                'driver-name': null,
                'team-name': null
            };
        }

        function openRaceInfoModal(data) {

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = '';

            function getFastestTimesRecordsContent(data) {

                function insertFastestRow(data, timesRecordsTableBody, category, searchKey) {

                    const fastestLapTime = data["records"]["fastest"][searchKey]["time-str"];
                    const fastestDriverIndex = data["records"]["fastest"][searchKey]["driver-index"];
                    const fastestLapNum = data["records"]["fastest"][searchKey]["lap-number"];
                    const driverIndex = data["records"]["fastest"][searchKey]["driver-index"];
                    const driverName = data["records"]["fastest"][searchKey]["driver-name"];
                    const teamName = data["records"]["fastest"][searchKey]["team-id"];
                    const row = timesRecordsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${category}</td>
                        <td>${driverName}</td>
                        <td>${teamName}</td>
                        <td>${fastestLapNum}</td>
                        <td>${fastestLapTime}</td>
                    `;
                }

                const timesRecordsContent = document.createElement('div');
                const timesRecordsSubDiv = document.createElement('div');
                const timesRecordsTable = document.createElement('table');
                timesRecordsSubDiv.appendChild(timesRecordsTable);
                timesRecordsTable.classList.add('times-records-table');

                const timesRecordsHeader = timesRecordsTable.createTHead();
                const headerRow = timesRecordsHeader.insertRow();
                headerRow.innerHTML = `
                    <th>Category</th>
                    <th>Driver</th>
                    <th>Team</th>
                    <th>Lap</th>
                    <th>Time</th>
                `;

                const timesRecordsTableBody = timesRecordsTable.createTBody();
                if ("records" in data && 'fastest' in data["records"] && data["records"]["fastest"] != null) {
                    if ('lap' in data["records"]["fastest"]) {
                        insertFastestRow(data, timesRecordsTableBody, "Lap", "lap");
                    }
                    if ('s1' in data["records"]["fastest"]) {
                        insertFastestRow(data, timesRecordsTableBody, "Sector 1", "s1");
                    }
                    if ('s2' in data["records"]["fastest"]) {
                        insertFastestRow(data, timesRecordsTableBody, "Sector 2", "s2");
                    }
                    if ('s3' in data["records"]["fastest"]) {
                        insertFastestRow(data, timesRecordsTableBody, "Sector 3", "s3");
                    }

                } else {
                    const row = timesRecordsTableBody.insertRow();
                    row.innerHTML = '<td colspan="5">Fastest Times Records data not available</td>';
                }
                timesRecordsContent.appendChild(createAccordion('Fastest Times Records', timesRecordsSubDiv));
                return timesRecordsContent;
            }

            function getTyreStintRecordsContent(data) {

                function insertTyreStintRecordRow(data, timesRecordsTableBody, compound, compoundRecords) {

                    const longestTyreStintDriverName = compoundRecords["longest-tyre-stint"]["driver-name"];
                    const longestTyreStintLength = compoundRecords["longest-tyre-stint"]["value"];

                    const lowestTyreWearPerLapDriverName = compoundRecords["lowest-tyre-wear-per-lap"]["driver-name"];
                    const lowestTyreWearPerLap = compoundRecords["lowest-tyre-wear-per-lap"]["value"];

                    const highestTyreWearDriverName = compoundRecords["highest-tyre-wear"]["driver-name"];
                    const highestTyreWear = compoundRecords["highest-tyre-wear"]["value"];

                    const row1 = timesRecordsTableBody.insertRow();
                    const compoundCell1 = row1.insertCell();
                    compoundCell1.textContent = compound;
                    compoundCell1.setAttribute('rowspan', '3'); // Merge cells vertically

                    row1.insertCell().textContent = 'Longest Stint';
                    row1.insertCell().textContent = longestTyreStintDriverName;
                    row1.insertCell().textContent = longestTyreStintLength + " laps";

                    const row2 = timesRecordsTableBody.insertRow();
                    row2.insertCell().textContent = 'Least Tyre Wear Per Lap';
                    row2.insertCell().textContent = lowestTyreWearPerLapDriverName;
                    row2.insertCell().textContent = formatFloatWithTwoDecimals(lowestTyreWearPerLap) + "%";

                    const row3 = timesRecordsTableBody.insertRow();
                    row3.insertCell().textContent = 'Highest Tyre Wear';
                    row3.insertCell().textContent = highestTyreWearDriverName;
                    row3.insertCell().textContent = highestTyreWear + "%";
                }

                const tyreStintRecordsContent = document.createElement('div');
                const tyreStintRecordsSubDiv = document.createElement('div');
                const tyreStintsRecordsTable = document.createElement('table');
                tyreStintRecordsSubDiv.appendChild(tyreStintsRecordsTable);
                tyreStintsRecordsTable.classList.add('tyre-stints-records-table');

                const tyreStintsRecordsHeader = tyreStintsRecordsTable.createTHead();
                const headerRow = tyreStintsRecordsHeader.insertRow();
                headerRow.innerHTML = `
                    <th>Compound</th>
                    <th>Category</th>
                    <th>Driver</th>
                    <th>Record</th>
                `;

                const tyreStintRecordsTableBody = tyreStintsRecordsTable.createTBody();
                if ("records" in data && 'tyre-stats' in data["records"] && data["records"]["tyre-stats"] != null) {

                    const tyreStats = data["records"]["tyre-stats"];
                    for (let compound in tyreStats) {
                        const compoundRecords = tyreStats[compound];
                        insertTyreStintRecordRow(data, tyreStintRecordsTableBody, compound, compoundRecords);
                    }

                } else {
                    const row = tyreStintRecordsTableBody.insertRow();
                    row.innerHTML = '<td colspan="5">Tyre Stint Records data not available</td>';
                }
                tyreStintRecordsContent.appendChild(createAccordion('Tyre Stint Records', tyreStintRecordsSubDiv));
                return tyreStintRecordsContent;
            }

            function getCustomMarkersContent(data) {

                const customMarkersContent = document.createElement('div');
                const customMarkersSubDiv = document.createElement('div');
                const customMarkersTable = document.createElement('table');
                customMarkersSubDiv.appendChild(customMarkersTable);
                customMarkersTable.classList.add('custom-markers-table');

                const customMarkersHeader = customMarkersTable.createTHead();
                const headerRow = customMarkersHeader.insertRow();
                headerRow.innerHTML = `
                    <th>Index</th>
                    <th>Event</th>
                    <th>Track</th>
                    <th>Sector</th>
                    <th>Lap Number</th>
                    <th>Curr Lap Time</th>
                    <th>Lap Percentage</th>
                `;

                const customMarkersTableBody = customMarkersTable.createTBody();
                if ("custom-markers" in data && data["custom-markers"].length > 0) {

                    data["custom-markers"].forEach(function (marker, index) {
                        const row = customMarkersTableBody.insertRow();
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${marker["event-type"]}</td>
                            <td>${marker["track"]}</td>
                            <td>${marker["sector"]}</td>
                            <td>${marker["lap"]}</td>
                            <td>${marker["curr-lap-time"]}</td>
                            <td>${marker["curr-lap-percentage"]}</td>
                        `;
                    });

                } else {
                    const row = customMarkersTableBody.insertRow();
                    row.innerHTML = '<td colspan="7">Custom Markers data not available</td>';
                }
                customMarkersContent.appendChild(createAccordion('Custom Markers', customMarkersSubDiv));
                return customMarkersContent;
            }

            // Fastest Times Records Table
            modalContent.appendChild(getFastestTimesRecordsContent(data));

            // Tyre Stints Records Table
            modalContent.appendChild(getTyreStintRecordsContent(data));

            // Custom Markers Table
            modalContent.appendChild(getCustomMarkersContent(data));

            // Finalise the data
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.innerText = `Race Information`;

            const modal = document.getElementById('driverInfoModal');
            modal.style.display = 'block';
        }

        function openDriverInfoModal(data) {

            // Function to plot the graph with dark theme, truncated Y-axis values, and 30% excess
            function plotGraph(canvas, datasets, xAxisLabel, yAxisLabel, formatAsLapTime = false, limits = null) {
                // Convert data to lap time format if specified
                const excessPerc = 0.2;
                if (formatAsLapTime) {
                    datasets.forEach(dataset => {
                        dataset.data.forEach(entry => {
                            entry.lapTimeString = formatLapTime(entry.y); // Store lap time string for display
                        });
                    });
                }

                var xData = datasets[0].data.map(entry => entry.x);

                let yMinWithExcess, yMaxWithExcess;
                // Calculate the range of the data
                var yMin = Math.min(...datasets.reduce((acc, dataset) => acc.concat(dataset.data.map(entry => entry.y)), []));
                var yMax = Math.max(...datasets.reduce((acc, dataset) => acc.concat(dataset.data.map(entry => entry.y)), []));

                // Calculate the 30% excess
                var excess = (yMax - yMin) * excessPerc;

                // Adjust the minimum and maximum values for the Y-axis scale with excess
                if (limits !== null) {
                    if (!("min" in limits) || limits["min"] === null) {
                        yMinWithExcess = yMin - excess;
                    } else {
                        yMinWithExcess = limits["min"];
                    }

                    if (!("max" in limits) || limits["max"] === null) {
                        yMaxWithExcess = yMax + excess;
                    } else {
                        yMaxWithExcess = limits["max"];
                    }
                }

                var ctx = canvas.getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: xData,
                        datasets: datasets.map(dataset => ({
                            ...dataset,
                            data: dataset.data.map(entry => entry.y), // Use numerical values for chart
                            label: formatAsLapTime ? dataset.label + " (Lap Time)" : dataset.label // Update label if formatting as lap time
                        }))
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'linear',
                                scaleLabel: {
                                    display: true,
                                    labelString: xAxisLabel,
                                    fontColor: 'rgba(255, 255, 255, 0.8)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    stepSize: 1, // Ensure each lap number is displayed
                                    precision: 0 // Round to whole numbers
                                }
                            },
                            y: {
                                scaleLabel: {
                                    display: true,
                                    labelString: yAxisLabel,
                                    fontColor: 'rgba(255, 255, 255, 0.8)'
                                },
                                beginAtZero: false,
                                min: yMinWithExcess,
                                max: yMaxWithExcess,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    callback: function (value, index, values) {
                                        // Format tick values as lap time if formatting as lap time is enabled
                                        return formatAsLapTime ? formatLapTime(value) : value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.8)'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        var label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatAsLapTime ? formatLapTime(context.parsed.y) : context.parsed.y;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        layout: {
                            padding: {
                                top: 10,
                                right: 10,
                                bottom: 10,
                                left: 10
                            }
                        },
                        responsive: true
                    }
                });
            }

            function getCarDamageContent(data) {

                const carDamageContent = document.createElement('div');
                const carDamageTable = document.createElement('table');
                carDamageTable.classList.add('car-damage-table');
                const carDamageHeader = carDamageTable.createTHead();
                const carDamageHeaderRow = carDamageHeader.insertRow();
                carDamageHeaderRow.innerHTML = `
                    <th>Component</th>
                    <th>Damage</th>
                `;
                const carDamageBody = carDamageTable.createTBody();
                if ("car-damage" in data && data["car-damage"] != null) {
                    // Front Left Wing Damage
                    const row1 = carDamageBody.insertRow();
                    row1.innerHTML = `
                        <td>Front Left Wing Damage</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["front-left-wing-damage"])}%</td>
                    `;

                    // Front Right Wing Damage
                    const row2 = carDamageBody.insertRow();
                    row2.innerHTML = `
                        <td>Front Right Wing Damage</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["front-right-wing-damage"])}%</td>
                    `;

                    // Rear Wing Damage
                    const row3 = carDamageBody.insertRow();
                    row3.innerHTML = `
                        <td>Rear Wing Damage</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["rear-wing-damage"])}%</td>
                    `;
                } else {
                    const row = carDamageBody.insertRow();
                    row.innerHTML = '<td colspan="2">Car Damage data not available</td>';
                }
                carDamageContent.appendChild(createAccordion('Car Damage', carDamageTable));
                return carDamageContent;
            }

            function getTyreDamageContent(data) {

                const tyreDamageContent = document.createElement('div');
                const tyreDamageTable = document.createElement('table');
                tyreDamageTable.classList.add('tyre-damage-table');
                const tyreDamageHeader = tyreDamageTable.createTHead();
                const tyreDamageHeaderRow = tyreDamageHeader.insertRow();
                tyreDamageHeaderRow.innerHTML = `
                    <th>Tyre</th>
                    <th>Damage</th>
                `;
                const tyreDamageBody = tyreDamageTable.createTBody();
                if ("car-damage" in data && data["car-damage"] != null) {
                    // Front Left Tyre Damage
                    const row1 = tyreDamageBody.insertRow();
                    row1.innerHTML = `
                        <td>Front Left Tyre Damage</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-damage"][2])}%</td>
                    `;

                    // Front Right Tyre Damage
                    const row2 = tyreDamageBody.insertRow();
                    row2.innerHTML = `
                        <td>Front Right Tyre Damage</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-damage"][3])}%</td>
                    `;

                    // Rear Left Tyre Damage
                    const row3 = tyreDamageBody.insertRow();
                    row3.innerHTML = `
                        <td>Rear Left Tyre Damage</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-damage"][0])}%</td>
                    `;

                    // Rear Right Tyre Damage
                    const row4 = tyreDamageBody.insertRow();
                    row4.innerHTML = `
                        <td>Rear Right Tyre Damage</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-damage"][1])}%</td>
                    `;
                } else {
                    const row = tyreDamageBody.insertRow();
                    row.innerHTML = '<td colspan="2">Tyre Damage data not available</td>';
                }
                tyreDamageContent.appendChild(createAccordion('Tyre Damage', tyreDamageTable));
                return tyreDamageContent;
            }

            function getTyreWearContent(data) {

                const tyreWearContent = document.createElement('div');
                const tyreWearTable = document.createElement('table');
                tyreWearTable.classList.add('tyre-damage-table');
                const tyreWearHeader = tyreWearTable.createTHead();
                const tyreWearHeaderRow = tyreWearHeader.insertRow();
                tyreWearHeaderRow.innerHTML = `
                    <th>Tyre</th>
                    <th>Wear</th>
                `;
                const tyreWearBody = tyreWearTable.createTBody();
                if ("car-damage" in data && data["car-damage"] != null) {
                    // Front Left Tyre Wear
                    const row1 = tyreWearBody.insertRow();
                    row1.innerHTML = `
                        <td>Front Left Tyre Wear</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-wear"][2])}%</td>
                    `;

                    // Front Right Tyre Wear
                    const row2 = tyreWearBody.insertRow();
                    row2.innerHTML = `
                        <td>Front Right Tyre Wear</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-wear"][3])}%</td>
                    `;

                    // Rear Left Tyre Wear
                    const row3 = tyreWearBody.insertRow();
                    row3.innerHTML = `
                        <td>Rear Left Tyre Wear</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-wear"][0])}%</td>
                    `;

                    // Rear Right Tyre Wear
                    const row4 = tyreWearBody.insertRow();
                    row4.innerHTML = `
                        <td>Rear Right Tyre Wear</td>
                        <td>${formatFloatWithTwoDecimals(data["car-damage"]["tyres-wear"][1])}%</td>
                    `;
                } else {
                    const row = tyreWearBody.insertRow();
                    row.innerHTML = '<td colspan="2">Tyre Wear data not available</td>';
                }
                tyreWearContent.appendChild(createAccordion('Tyre Wear', tyreWearTable));
                return tyreWearContent;
            }

            function getLapHistoryContent(data) {

                const lapHistoryContent = document.createElement('div');
                const lapHistorySubDiv = document.createElement('div');
                const lapHistoryTable = document.createElement('table');
                lapHistorySubDiv.appendChild(lapHistoryTable);
                lapHistoryTable.classList.add('lap-history-table');

                const lapHistoryHeader = lapHistoryTable.createTHead();
                const headerRow = lapHistoryHeader.insertRow();
                headerRow.innerHTML = `
                    <th>Lap</th>
                    <th>S1 Time</th>
                    <th>S2 Time</th>
                    <th>S3 Time</th>
                    <th>Total Time</th>
                `;

                const lapHistoryBody = lapHistoryTable.createTBody();
                // Data arrays for plotting graph
                let graphDataS1 = [];
                let graphDataS2 = [];
                let graphDataS3 = [];
                let graphDataTotal = [];
                if ("session-history" in data && data["session-history"] != null) {
                    const lapHistoryData = data["session-history"]["lap-history-data"];
                    const bestLapNum = data["session-history"]["best-lap-time-lap-num"];
                    const bestSector1Num = data["session-history"]["best-sector-1-lap-num"];
                    const bestSector2Num = data["session-history"]["best-sector-2-lap-num"];
                    const bestSector3Num = data["session-history"]["best-sector-3-lap-num"];

                    lapHistoryData.forEach((lap, index) => {
                        const row = lapHistoryBody.insertRow();
                        const currentLapNum = index + 1;

                        if (lap["lap-time-in-ms"] == 0 &&
                            lap["sector-1-time-in-ms"] == 0 &&
                            lap["sector-2-time-in-ms"] == 0 &&
                            lap["sector-3-time-in-ms"] == 0) {
                            return;
                        }

                        row.innerHTML = `
                            <td>${currentLapNum}</td>
                            <td>${lap["sector-1-time-str"]}</td>
                            <td>${lap["sector-2-time-str"]}</td>
                            <td>${lap["sector-3-time-str"]}</td>
                            <td>${lap["lap-time-str"]}</td>
                        `;

                        // Check and mark green for best sector 1
                        const greenSectorColor = '#32F129';
                        const redSectorColor = '#f12929';
                        const fullLapValidBitMask = 1;
                        const sector1ValidBitMask = 2;
                        const sector2ValidBitMask = 4;
                        const sector3ValidBitMask = 8;

                        if (currentLapNum === bestSector1Num) {
                            row.cells[1].style.color = greenSectorColor;
                        } else if ((lap["lap-valid-bit-flags"] & sector1ValidBitMask) == 0) {
                            row.cells[1].style.color = redSectorColor;
                        }

                        // Check and mark green for best sector 2
                        if (currentLapNum === bestSector2Num) {
                            row.cells[2].style.color = greenSectorColor;
                        } else if ((lap["lap-valid-bit-flags"] & sector2ValidBitMask) == 0) {
                            row.cells[2].style.color = redSectorColor;
                        }

                        // Check and mark green for best sector 3
                        if (currentLapNum === bestSector3Num) {
                            row.cells[3].style.color = greenSectorColor;
                        } else if ((lap["lap-valid-bit-flags"] & sector3ValidBitMask) == 0) {
                            row.cells[3].style.color = redSectorColor;
                        }

                        // Check and mark green for total time
                        if (currentLapNum === bestLapNum) {
                            row.cells[4].style.color = greenSectorColor;
                        } else if ((lap["lap-valid-bit-flags"] & fullLapValidBitMask) == 0) {
                            row.cells[4].style.color = redSectorColor;
                        }

                        // Insert into the data structure for the graph
                        graphDataS1.push({ x: currentLapNum, y: lap["sector-1-time-in-ms"] });
                        graphDataS2.push({ x: currentLapNum, y: lap["sector-2-time-in-ms"] });
                        graphDataS3.push({ x: currentLapNum, y: lap["sector-3-time-in-ms"] });
                        graphDataTotal.push({ x: currentLapNum, y: lap["lap-time-in-ms"] });
                    });
                } else {
                    const row = lapHistoryBody.insertRow();
                    row.innerHTML = '<td colspan="5">Lap History data not available</td>';
                }

                if (graphDataTotal.length > 0) {
                    // Create graph canvas
                    const graphDiv = document.createElement('div');
                    const elementId = 'lapTimeGraph';
                    const graphCanvas = document.createElement('canvas');
                    graphDiv.appendChild(graphCanvas);
                    graphCanvas.id = elementId;
                    graphDiv.classList.add('graph-canvas');
                    // graphCanvas.classList.add('graph-canvas');

                    // Plot graph
                    var datasets = [
                        {
                            label: 'S1 Time',
                            data: graphDataS1
                        },
                        {
                            label: 'S2 Time',
                            data: graphDataS2
                        },
                        {
                            label: 'S3 Time',
                            data: graphDataS3
                        },
                        {
                            label: 'Lap Time',
                            data: graphDataTotal
                        }
                    ];
                    limits = {
                        min: 0
                    }
                    const formatAsLapTime = true;
                    plotGraph(graphCanvas, datasets, 'Lap number', 'Time', formatAsLapTime, limits);
                    lapHistorySubDiv.appendChild(graphDiv);
                }
                lapHistoryContent.appendChild(createAccordion('Lap History', lapHistorySubDiv));
                return lapHistoryContent;
            }

            function getErsHistoryContent(data) {

                const ersHistoryContent = document.createElement('div');
                const ersHistoryTable = document.createElement('table');
                const ersHistorySubDiv = document.createElement('div');
                ersHistoryTable.classList.add('ers-damage-table');
                ersHistorySubDiv.appendChild(ersHistoryTable);
                const ersHistoryHeader = ersHistoryTable.createTHead();
                const ersHistoryHeaderRow = ersHistoryHeader.insertRow();
                ersHistoryHeaderRow.innerHTML = `
                    <th>Lap</th>
                    <th>ERS remaining</th>
                    <th>ERS deployed</th>
                    <th>Harvested - MGU-H</th>
                    <th>Harvested - MGU-K</th>
                    <th>Harvested - Total</th>
                `;
                const ersHistoryBody = ersHistoryTable.createTBody();
                // Data arrays for plotting graph
                let graphDataDeployed = [];
                let graphDataRemaining = [];
                let graphDataHarvested = [];

                if ("per-lap-info" in data && data["per-lap-info"] != null) {
                    const perLapHistoryData = data["per-lap-info"];
                    if (perLapHistoryData.length > 0) {
                        perLapHistoryData.forEach((lap, index) => {
                            const row = ersHistoryBody.insertRow();
                            const currentLapNum = lap["lap-number"];
                            if (currentLapNum == 0) {
                                // Skip lap 0 for ERS, we want that only for fuel
                                // If this is the only lap info available, print the standard error message
                                if (perLapHistoryData.length == 1) {
                                    row.innerHTML = '<td colspan="6">ERS data not available</td>';
                                }

                                return;
                            }
                            let ersRemainingPerc = "---";
                            let ersDeployedPerc = "---";
                            let ersHarvestedMguHPerc = "---";
                            let ersHarvestedMguKPerc = "---";
                            let ersHarvestedTotalPerc = "---";

                            if ("car-status-data" in lap) {
                                const maxErsCapacity = lap["car-status-data"]["ers-max-capacity"];
                                const ersRemainingVal = lap["car-status-data"]["ers-store-energy"];
                                const ersDeployedThisLapVal = lap["car-status-data"]["ers-deployed-this-lap"];
                                const ersHarvestedThisLapMguHVal = lap["car-status-data"]["ers-harvested-this-lap-mguh"];
                                const ersHarvestedThisLapMguKVal = lap["car-status-data"]["ers-harvested-this-lap-mguk"];

                                ersRemainingPerc = formatFloatWithTwoDecimals(
                                    (ersRemainingVal / maxErsCapacity) * 100) + "%";
                                ersDeployedPerc = formatFloatWithTwoDecimals(
                                    (ersDeployedThisLapVal / maxErsCapacity) * 100) + "%";
                                ersHarvestedMguHPerc = formatFloatWithTwoDecimals(
                                    (ersHarvestedThisLapMguHVal / maxErsCapacity) * 100) + "%";
                                ersHarvestedMguKPerc = formatFloatWithTwoDecimals(
                                    (ersHarvestedThisLapMguKVal / maxErsCapacity) * 100) + "%";
                                ersHarvestedTotalPerc = formatFloatWithTwoDecimals(
                                    ((ersHarvestedThisLapMguHVal + ersHarvestedThisLapMguKVal) / maxErsCapacity)
                                    * 100) + "%";

                                graphDataDeployed.push({ x: parseFloat(currentLapNum), y: ((ersDeployedThisLapVal / maxErsCapacity) * 100) });
                                graphDataRemaining.push({ x: parseFloat(currentLapNum), y: ((ersRemainingVal / maxErsCapacity) * 100) });
                                graphDataHarvested.push({ x: parseFloat(currentLapNum), y: (((ersHarvestedThisLapMguHVal + ersHarvestedThisLapMguKVal) / maxErsCapacity) * 100) });
                            }

                            row.innerHTML = `
                                <td>${currentLapNum}</td>
                                <td>${ersRemainingPerc}</td>
                                <td>${ersDeployedPerc}</td>
                                <td>${ersHarvestedMguHPerc}</td>
                                <td>${ersHarvestedMguKPerc}</td>
                                <td>${ersHarvestedTotalPerc}</td>
                            `;
                        });
                    } else {
                        const row = ersHistoryBody.insertRow();
                        row.innerHTML = '<td colspan="6">ERS History data not available</td>';
                    }
                } else {
                    const row = ersHistoryBody.insertRow();
                    row.innerHTML = '<td colspan="6">ERS History data not available</td>';
                }

                if (graphDataDeployed.length > 0) {
                    // Create graph canvas
                    const graphDiv = document.createElement('div');
                    const elementId = 'ersGraph';
                    const graphCanvas = document.createElement('canvas');
                    graphDiv.appendChild(graphCanvas);
                    graphCanvas.id = elementId;
                    graphDiv.classList.add('graph-canvas');
                    // graphCanvas.classList.add('graph-canvas');

                    // Plot graph
                    var datasets = [
                        {
                            label: 'ERS Deployed',
                            data: graphDataDeployed
                        },
                        {
                            label: 'ERS Remaining',
                            data: graphDataRemaining
                        },
                        {
                            label: 'ERS Harvested',
                            data: graphDataHarvested
                        }
                    ];
                    var limits = {
                        min: 0,
                        max: 100
                    }
                    const formatAsLapTime = false;
                    plotGraph(graphCanvas, datasets, 'Lap number', 'ERS (%)', formatAsLapTime, limits);
                    ersHistorySubDiv.appendChild(graphDiv);
                }
                ersHistoryContent.appendChild(createAccordion('ERS History', ersHistorySubDiv));
                return ersHistoryContent;
            }

            function getFuelHistoryContent(data) {

                const fuelHistoryContent = document.createElement('div');
                const fuelHistorySubDiv = document.createElement('div');
                const fuelHistoryTable = document.createElement('table');
                fuelHistorySubDiv.appendChild(fuelHistoryTable);
                fuelHistoryTable.classList.add('fuel-damage-table');
                const fuelHistoryHeader = fuelHistoryTable.createTHead();
                const fuelHistoryHeaderRow = fuelHistoryHeader.insertRow();
                fuelHistoryHeaderRow.innerHTML = `
                    <th>Lap</th>
                    <th>Fuel Load (kg)</th>
                    <th>Usage Per Lap</th>
                    <th>Excess Laps</th>
                    <th>Excess Laps Delta</th>
                `;
                const fuelHistoryBody = fuelHistoryTable.createTBody();
                // Data array for plotting graph
                let graphData = [];

                if ("per-lap-info" in data && data["per-lap-info"] != null) {
                    const perLapHistoryData = data["per-lap-info"];
                    if (perLapHistoryData.length > 0) {
                        perLapHistoryData.forEach((lap, index) => {
                            const row = fuelHistoryBody.insertRow();
                            const currentLapNum = lap["lap-number"];

                            let fuelLoad = "---";
                            let fuelLaps = "---";
                            let usagePerLap = "---";
                            let fuelLapsDelta = "---";

                            if ("car-status-data" in lap) {
                                const fuelLoadVal = lap["car-status-data"]["fuel-in-tank"];
                                const fuelLapsVal = lap["car-status-data"]["fuel-remaining-laps"];

                                fuelLoad = formatFloatWithTwoDecimals(fuelLoadVal);
                                fuelLaps = formatFloatWithTwoDecimals(fuelLapsVal);

                                if (index > 0 && "car-status-data" in data["per-lap-info"][index - 1]) {
                                    const fuelLoadValPrev = data["per-lap-info"][index - 1]["car-status-data"]["fuel-in-tank"];
                                    const fuelLapsValPrev = data["per-lap-info"][index - 1]["car-status-data"]["fuel-remaining-laps"];

                                    usagePerLap = formatFloatWithTwoDecimalsSigned(fuelLoadValPrev - fuelLoadVal);
                                    fuelLapsDelta = formatFloatWithTwoDecimalsSigned(fuelLapsValPrev - fuelLapsVal);
                                }
                            }

                            // Push data to graphData array
                            if (currentLapNum > 0) {
                                graphData.push({ x: parseFloat(currentLapNum), y: parseFloat(usagePerLap) });
                            }

                            row.innerHTML = `
                                <td>${currentLapNum}</td>
                                <td>${fuelLoad}</td>
                                <td>${usagePerLap}</td>
                                <td>${fuelLaps}</td>
                                <td>${fuelLapsDelta}</td>
                            `;
                        });
                    } else {
                        const row = fuelHistoryBody.insertRow();
                        row.innerHTML = '<td colspan="6">ERS History data not available</td>';
                    }
                } else {
                    const row = fuelHistoryBody.insertRow();
                    row.innerHTML = '<td colspan="6">ERS History data not available</td>';
                }

                if (graphData.length > 0) {
                    // Create graph canvas

                    const graphDiv = document.createElement('div');
                    const elementId = 'fuelLoadGraph';
                    const graphCanvas = document.createElement('canvas');
                    graphDiv.appendChild(graphCanvas);
                    graphCanvas.id = elementId;
                    graphDiv.classList.add('graph-canvas');
                    // graphCanvas.classList.add('graph-canvas');

                    // Plot graph
                    var datasets = [
                        {
                            label: 'Fuel Usage Per Lap Graph',
                            data: graphData
                        }
                    ];
                    var limits = {
                        min: 0
                    }
                    const formatAsLapTime = false;
                    plotGraph(graphCanvas, datasets, 'Lap number', 'Fuel Usage (kg)', formatAsLapTime, limits);
                    fuelHistorySubDiv.appendChild(graphDiv);
                }
                fuelHistoryContent.appendChild(createAccordion('Fuel History', fuelHistorySubDiv));
                return fuelHistoryContent;
            }

            // Remove tyre sets that are not available and sort them by compound name
            function getTyreSetsInfoContent(data) {

                function sanitizeTyreSetData(tyre_set_data) {
                    const available_tyres = tyre_set_data
                        .filter(tyre => tyre.available === true)
                        .map((tyre, index) => ({ ...tyre, index }));
                    const sorted_tyres = available_tyres.sort(
                        (a, b) => a["actual-tyre-compound"].localeCompare(b["actual-tyre-compound"]));
                    return sorted_tyres;
                }

                const tyreSetsInfoContent = document.createElement('div');
                const tyreSetsInfoTable = document.createElement('table');
                tyreSetsInfoTable.classList.add('tyre-sets-info-table');
                const tyreSetsInfoTableHeader = tyreSetsInfoTable.createTHead();
                const tyreSetsInfoTableHeaderRow = tyreSetsInfoTableHeader.insertRow();
                tyreSetsInfoTableHeaderRow.innerHTML = `
                    <th>Index</th>
                    <th>Compound</th>
                    <th>Wear</th>
                    <th>Lifespan</th>
                    <th>Lap Delta</th>
                `;
                const tyreSetsInfoBody = tyreSetsInfoTable.createTBody();
                if ("tyre-sets" in data && data["tyre-sets"] != null) {

                    const tyreSetsInfoList = sanitizeTyreSetData(data["tyre-sets"]["tyre-set-data"]);
                    if (tyreSetsInfoList.length > 0) {

                        tyreSetsInfoList.forEach((tyreSet) => {
                            const row = tyreSetsInfoBody.insertRow();
                            row.innerHTML = `
                                <td>${tyreSet["index"]}</td>
                                <td>${tyreSet["actual-tyre-compound"] + " - " + tyreSet["visual-tyre-compound"]}</td>
                                <td>${tyreSet["wear"]}</td>
                                <td>${tyreSet["life-span"]} laps</td>
                                <td>${formatFloatWithTwoDecimalsSigned(tyreSet["lap-delta-time"] / 1000)}s</td>
                            `;

                            if (tyreSet["fitted"]) {
                                row.style.color = '#32F129';
                            }
                        });
                    } else {
                        const row = tyreSetsInfoBody.insertRow();
                        row.innerHTML = '<td colspan="5">Tyre Sets data not available</td>';
                    }

                } else {
                    const row = tyreSetsInfoBody.insertRow();
                    row.innerHTML = '<td colspan="5">Tyre Sets data not available</td>';
                }
                tyreSetsInfoContent.appendChild(createAccordion('Tyre Sets', tyreSetsInfoTable));
                return tyreSetsInfoContent;
            }

            function getTyreWearPredictionsContent(data) {

                const tyreWearPredictionsInfoContent = document.createElement('div');
                const tyreWearPredictionsInfoTable = document.createElement('table');
                tyreWearPredictionsInfoTable.classList.add('tyre-wear-predictions-info-table');
                const tyreWearPredictionsInfoTableHeader = tyreWearPredictionsInfoTable.createTHead();
                const tyreWearPredictionsInfoTableHeaderRow = tyreWearPredictionsInfoTableHeader.insertRow();
                tyreWearPredictionsInfoTableHeaderRow.innerHTML = `
                    <th>Lap</th>
                    <th>FL</th>
                    <th>FR</th>
                    <th>RL</th>
                    <th>RR</th>
                    <th>Average</th>
                `;
                const tyreWearPredictionsInfoBody = tyreWearPredictionsInfoTable.createTBody();
                if ("tyre-wear-predictions" in data && data["tyre-wear-predictions"] != null) {

                    const predictionsList = data["tyre-wear-predictions"]["predictions"];
                    const selectedPitStopLap = data["tyre-wear-predictions"]["selected-pit-stop-lap"];
                    if (predictionsList.length > 0) {

                        predictionsList.forEach((prediction) => {
                            const row = tyreWearPredictionsInfoBody.insertRow();
                            const fl  = prediction["front-left-wear"];
                            const fr  = prediction["front-right-wear"];
                            const rl  = prediction["rear-left-wear"];
                            const rr  = prediction["rear-right-wear"];
                            const avg = (fl + fr + rl + rr) / 4;
                            const lap = prediction["lap-number"];
                            row.innerHTML = `
                                <td>${lap}</td>
                                <td>${formatFloatWithTwoDecimals(fl)}%</td>
                                <td>${formatFloatWithTwoDecimals(fr)}%</td>
                                <td>${formatFloatWithTwoDecimals(rl)}%</td>
                                <td>${formatFloatWithTwoDecimals(rr)}%</td>
                                <td>${formatFloatWithTwoDecimals(avg)}%</td>
                            `;

                            //TODO: Add logic to highlight selected pit stop
                        });
                    } else {
                        const row = tyreWearPredictionsInfoBody.insertRow();
                        row.innerHTML = '<td colspan="6">Tyre Wear Predictions data not available</td>';
                    }

                } else {
                    const row = tyreWearPredictionsInfoBody.insertRow();
                    row.innerHTML = '<td colspan="6">Tyre Wear Predictions data not available</td>';
                }
                tyreWearPredictionsInfoContent.appendChild(createAccordion('Tyre Wear Predictions', tyreWearPredictionsInfoTable));
                return tyreWearPredictionsInfoContent;
            }

            function getTyreStintHistoryContent(data) {

                const tyreStintHistoryContent = document.createElement('div');
                const tyreStintHistorySubDiv = document.createElement('div');
                const tyreStintHistoryTable = document.createElement('table');
                tyreStintHistorySubDiv.appendChild(tyreStintHistoryTable);
                tyreStintHistoryTable.classList.add('tyre-stint-history-table');

                const tyreStintHistoryHeader = tyreStintHistoryTable.createTHead();
                const tyreStintHistoryHeaderRow = tyreStintHistoryHeader.insertRow();
                tyreStintHistoryHeaderRow.innerHTML = `
                    <th>Stint number</th>
                    <th>Start Lap</th>
                    <th>End Lap</th>
                    <th>Stint Length</th>
                    <th>Compound</th>
                    <th>Tyre Set ID</th>
                    <th>Tyre Wear</th>
                    <th>Tyre Wear Per Lap</th>
                `;

                const tyreStintHistoryBody = tyreStintHistoryTable.createTBody();
                let graphDataFL = [];
                let graphDataFR = [];
                let graphDataRL = [];
                let graphDataRR = [];
                if ("tyre-set-history" in data && data["tyre-set-history"] != null) {
                    const tyreStintHistoryData = data["tyre-set-history"];
                    tyreStintHistoryData.forEach((stintData, index) => {
                        const row = tyreStintHistoryBody.insertRow();
                        const stintId = index + 1;

                        const stintStartLap = stintData["start-lap"];
                        const stintEndLap = stintData["end-lap"];
                        const stintLength = `${stintData["stint-length"]} lap(s)`;
                        let compound = "---";
                        let tyreSetId = "---";
                        let tyreWear = "---";
                        let tyreWearPerLap = "---";

                        if ("tyre-set-data" in stintData && stintData["tyre-set-data"] != null) {
                            const tyreSetData = stintData["tyre-set-data"];
                            const tyreSetIndex = stintData["fitted-index"];

                            const actualCompound = tyreSetData["actual-tyre-compound"];
                            compound = tyreSetData["visual-tyre-compound"];
                            tyreSetId = `${actualCompound} - ${tyreSetIndex}`;
                            tyreWear = `${formatFloatWithTwoDecimals(tyreSetData["wear"])}%`;

                            // Use parseFloat to ensure numerical calculation
                            const wearPerLap = parseFloat(tyreSetData["wear"]) / parseFloat(stintData["stint-length"]);
                            tyreWearPerLap = formatFloatWithTwoDecimals(wearPerLap) + "%";
                        }

                        if ("tyre-wear-history" in stintData && stintData["tyre-wear-history"].length > 0) {

                            const wearHistory = stintData["tyre-wear-history"];
                            wearHistory.forEach(wearData => {
                                graphDataFL.push({
                                    x: wearData["lap-number"],
                                    y: formatFloatWithTwoDecimals(wearData["front-left-wear"]),
                                    desc: wearData["desc"],
                                });
                                graphDataFR.push({
                                    x: wearData["lap-number"],
                                    y: formatFloatWithTwoDecimals(wearData["front-right-wear"]),
                                    desc: wearData["desc"],
                                });
                                graphDataRL.push({
                                    x: wearData["lap-number"],
                                    y: formatFloatWithTwoDecimals(wearData["rear-left-wear"]),
                                    desc: wearData["desc"],
                                });
                                graphDataRR.push({
                                    x: wearData["lap-number"],
                                    y: formatFloatWithTwoDecimals(wearData["rear-right-wear"]),
                                    desc: wearData["desc"],
                                });
                            });
                        }

                        row.innerHTML = `
                            <td>${stintId}</td>
                            <td>${stintStartLap}</td>
                            <td>${stintEndLap}</td>
                            <td>${stintLength}</td>
                            <td>${compound}</td>
                            <td>${tyreSetId}</td>
                            <td>${tyreWear}</td>
                            <td>${tyreWearPerLap}</td>
                        `;
                    });
                } else {
                    const row = tyreStintHistoryBody.insertRow();
                    row.innerHTML = '<td colspan="8">Tyre Stint History data not available</td>';
                }

                if (graphDataFL.length > 0) {
                    // Create graph canvas

                    const graphDiv = document.createElement('div');
                    const elementId = 'tyreWearGraph';
                    const graphCanvas = document.createElement('canvas');
                    graphDiv.appendChild(graphCanvas);
                    graphCanvas.id = elementId;
                    graphDiv.classList.add('graph-canvas');

                    // Plot graph
                    var datasets = [
                        {
                            label: 'Front Left Wear',
                            data: graphDataFL
                        },
                        {
                            label: 'Front Right Wear',
                            data: graphDataFR
                        },
                        {
                            label: 'Rear Left Wear',
                            data: graphDataRL
                        },
                        {
                            label: 'Rear Right Wear',
                            data: graphDataRR
                        }
                    ];
                    var limits = {
                        min: 0,
                    }
                    const formatAsLapTime = false;
                    plotGraph(graphCanvas, datasets, 'Lap number', 'Tyre Wear %', formatAsLapTime, limits);
                    tyreStintHistorySubDiv.appendChild(graphDiv);
                }

                tyreStintHistoryContent.appendChild(createAccordion('Tyre Stint History', tyreStintHistorySubDiv));
                return tyreStintHistoryContent;
            }

            function getWarningsAndPenaltiesContent(data) {

                const warningsPenaltiesContent = document.createElement('div');
                const warningsPenaltiesTable = document.createElement('table');
                warningsPenaltiesTable.classList.add('warnings-penalties-damage-table');
                const warningsPenaltiesHeader = warningsPenaltiesTable.createTHead();
                const warningsPenaltiesHeaderRow = warningsPenaltiesHeader.insertRow();
                warningsPenaltiesHeaderRow.innerHTML = '<th>Type</th><th>Value</th>';
                const warningsPenaltiesBody = warningsPenaltiesTable.createTBody();
                if ("lap-data" in data && data["lap-data"] != null) {
                    const lapData = data["lap-data"];
                    const numPenalties = lapData["penalties"];
                    const totalWarnings = lapData["total-warnings"];
                    const numCornerCuttingWarnings = lapData["corner-cutting-warnings"];
                    const numUnservedDriveThroughPens = lapData["num-unserved-drive-through-pens"];
                    const numUnservedStopGoPens = lapData["num-unserved-stop-go-pens"];

                    const row1 = warningsPenaltiesBody.insertRow();
                    row1.innerHTML = `
                        <td>Total penalties (time)</td>
                        <td>${numPenalties} sec</td>
                    `;

                    const row2 = warningsPenaltiesBody.insertRow();
                    row2.innerHTML = `
                        <td>Total warnings</td>
                        <td>${totalWarnings}</td>
                    `;

                    const row3 = warningsPenaltiesBody.insertRow();
                    row3.innerHTML = `
                        <td>Corner Cutting Warnings</td>
                        <td>${numCornerCuttingWarnings}</td>
                    `;

                    const row4 = warningsPenaltiesBody.insertRow();
                    row4.innerHTML = `
                        <td>Unserved Drive Through Penalties</td>
                        <td>${numUnservedDriveThroughPens}</td>
                    `;

                    const row5 = warningsPenaltiesBody.insertRow();
                    row5.innerHTML = `
                        <td>Unserved Stop Go Penalties</td>
                        <td>${numUnservedStopGoPens}</td>
                    `;

                    if (data["is-player"]) {
                        let naughtyStatus;
                        if (
                            numPenalties > 0 ||
                            totalWarnings > 0 ||
                            numCornerCuttingWarnings > 0 ||
                            numUnservedDriveThroughPens > 0 ||
                            numUnservedStopGoPens > 0
                        ) {
                            naughtyStatus = "Yes, You are naughty";
                        } else {
                            naughtyStatus = "Well, You may be naughty";
                        }
                        const row6 = warningsPenaltiesBody.insertRow();
                        row6.innerHTML = `
                            <td>Are you naughty?</td>
                            <td>${naughtyStatus}</td>
                        `;
                    }
                } else {
                    const row = warningsPenaltiesBody.insertRow();
                    row.innerHTML = '<td colspan="2">Tyre Wear data not available</td>';
                }
                warningsPenaltiesContent.appendChild(createAccordion('Warnings & Penalties', warningsPenaltiesTable));
                return warningsPenaltiesContent;
            }

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = '';

            const tyreWearPredictionsAvailable = "tyre-wear-predictions" in data &&
                (data["tyre-wear-predictions"]["status"] == true);

            // Car Damage Table
            modalContent.appendChild(getCarDamageContent(data));

            // Tyre Damage Table
            // modalContent.appendChild(getTyreDamageContent(data));

            // Tyre Wear Table
            modalContent.appendChild(getTyreWearContent(data));

            // Lap History Table
            modalContent.appendChild(getLapHistoryContent(data));

            // ERS history
            modalContent.appendChild(getErsHistoryContent(data));

            // Fuel history
            modalContent.appendChild(getFuelHistoryContent(data));

            // Tyre sets info
            modalContent.appendChild(getTyreSetsInfoContent(data));

            // Predictions
            modalContent.appendChild(getTyreWearPredictionsContent(data));

            // Tyre Stint History
            modalContent.appendChild(getTyreStintHistoryContent(data));

            // Warning and Penalties Table
            modalContent.appendChild(getWarningsAndPenaltiesContent(data));

            // Finalise the data
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.innerText = `Driver Information - ${data["driver-name"]} (${data["index"]})`;

            const modal = document.getElementById('driverInfoModal');
            modal.style.display = 'block';
        }

        function closeModal(elementId) {
            const modal = document.getElementById(elementId);
            modal.style.display = 'none';
        }

        function updateGlobalInfo(circuit, event_type, track_temp, curr_lap, total_laps,
            safety_car_status, fastest_lap, pit_speed_limit, packet_capture_enabled) {

            document.getElementById('tableTitle').textContent = `${event_type} - ${circuit}`;
            document.getElementById('trackTemperature').textContent = `Track Temperature: ${track_temp} C`;
            document.getElementById('lapInformation').textContent = `Lap: ${curr_lap}/${total_laps}`;
            document.getElementById('safetyCarStatus').textContent = `Safety Car Status: ${safety_car_status}`;
            document.getElementById('fastestLapOverall').textContent = `Fastest Lap Overall: ${fastest_lap}`;
            document.getElementById('pitSpeedLimit').textContent = `Pit Lane Speed Limit: ${pit_speed_limit} kmph`;

            const saveTelemetryLink = document.getElementById('saveTelemetryLink');
            saveTelemetryLink.style.display = packet_capture_enabled ? 'inline' : 'none';
        }

        function updateLocalTime() {
            const now = new Date();
            const options = {
                hour12: !is24HourFormat
            };
            const timeString = now.toLocaleTimeString('en-US', options);
            document.getElementById('localTime').textContent = `Local Time: ${timeString}`;
        }

        function toggleTimeFormat() {
            is24HourFormat = !is24HourFormat;
            updateLocalTime();
        }

        function toggleDeltaFormat() {
            relativeDelta = !relativeDelta;
        }

        function toggleLastLapFormat() {
            lastLapAbsoluteFormat = !lastLapAbsoluteFormat;
        }

        function toggleBestLapFormat() {
            bestLapAbsoluteFormat = !bestLapAbsoluteFormat;
        }

        function formatFileSize(bytes) {
            const sizes = ['Bytes', 'kB', 'MB', 'GB', 'TB'];

            if (bytes === 0) return '0 Byte';

            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            const sizeUnit = sizes[Math.min(i, sizes.length - 1)];
            const formattedSize = Math.round((bytes / Math.pow(1024, i)) * 100) / 100;

            return `${formattedSize} ${sizeUnit}`;
        }

        document.getElementById("saveTelemetryLink").addEventListener("click", function () {
            fetch('/save-telemetry-capture')
                .then(response => response.json())
                .then(data => {
                    if (data['status-code'] === 'SUCCESS') {
                        const formattedFileSize = formatFileSize(data['num-bytes']);
                        const numPacketsWithCommas = data['num-packets'].toLocaleString();

                        Swal.fire({
                            icon: 'success',
                            title: 'Telemetry captured!',
                            html: `Written to file: ${data['file-name']}.<br>${numPacketsWithCommas} packets written.<br>File size: ${formattedFileSize}.`,
                        });
                    } else if (data['status-code'] === 'DISABLED') {
                        Swal.fire({
                            icon: 'info',
                            title: 'Telemetry capture is disabled!',
                            text: 'Please enable telemetry capture.',
                        });
                    } else {
                        if (data["num-packets"] === 0) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error capturing telemetry!',
                                text: 'There is no data available to write to file',
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error capturing telemetry!',
                                text: JSON.stringify(data),
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching telemetry capture details:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error fetching telemetry capture details!',
                        text: 'Please check the console for more information.',
                    });
                });
        });

        document.getElementById("getRaceInfo").addEventListener("click", function () {
            fetch(`/race-info`)
                .then(response => response.json())
                .then(data => {
                    openRaceInfoModal(data);
                })
                .catch(error => {
                    console.error('Error fetching race info:', error);
                });
        });

        function hideColumn(columnName) {
            var raceTable = document.getElementById("raceTable");
            var headers = raceTable.getElementsByTagName("th");

            // Find the Delta column header
            for (var i = 0; i < headers.length; i++) {
                if (headers[i].textContent === columnName) {
                    headers[i].style.display = hideColumn ? "none" : "";
                    break;
                }
            }
        }


        // Add an event listener to the hyperlink
        document.getElementById('localTime').addEventListener('click', toggleTimeFormat);
        document.getElementById('deltaLink').addEventListener('click', toggleDeltaFormat);
        document.getElementById('lastLapLink').addEventListener('click', toggleLastLapFormat);
        document.getElementById('bestLapLink').addEventListener('click', toggleBestLapFormat);

        // Fetch data at intervals specified from jinja
        setInterval(fetchDataAndDisplay, {{ client_poll_interval_ms | tojson | safe }});

        // Update local time every second
        setInterval(updateLocalTime, 1000);

        // Initial fetch and display
        fetchDataAndDisplay();
        updateLocalTime();


        if (shouldHideDeltaColumn) {
            hideColumn("Delta");
        }
        if (shouldHidePredictionColumn) {
            hideColumn("Wear Prediction");
        }

        // Configure Chart.js to use Moment.js as the date adapter
        // Chart.defaults.global.plugins.moment = {
        //     locale: 'en' // Optional: set locale
        // };

    </script>
</body>

</html>